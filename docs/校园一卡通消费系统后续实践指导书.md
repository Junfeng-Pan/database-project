这是一份为您定制的《校园一卡通消费系统后续实践指导书》。

这份文档承接之前的“设计阶段”（需求、概念、逻辑设计），重点指导接下来的**数据库实现**、**数据操作**、**高级对象管理**以及**应用开发**等实战环节。请按照以下步骤在您的 openGauss 环境中执行。

---

# 校园一卡通消费系统后续实践指导书

## 1. 阶段三：数据库实现 (DDL)

本阶段的目标是在 openGauss 中创建真实的数据库、Schema 和表结构。

### 1.1 创建数据库与 Schema

请使用 `gsql` 或 Data Studio 连接到数据库后执行：

```sql
-- 1. 创建数据库
CREATE DATABASE campus_card WITH ENCODING = 'UTF8';

-- 2. 切换到新数据库 (如果在 gsql 中)
\c campus_card

-- 3. 创建模式 Schema
CREATE SCHEMA campus;

-- 4. 设置搜索路径 (方便后续操作)
SET search_path TO campus, public;

```

### 1.2 创建表结构

根据之前的物理设计，执行以下 SQL 建表语句：

```sql
-- 1. 用户表 (Users)
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    name VARCHAR(20) NOT NULL,
    identity_no CHAR(18) NOT NULL UNIQUE,
    phone VARCHAR(11),
    email VARCHAR(50),
    password VARCHAR(32) NOT NULL,
    user_type VARCHAR(10) CHECK(user_type IN ('Student', 'Teacher'))
);

-- 2. 商户表 (Merchants)
CREATE TABLE merchants (
    merchant_id SERIAL PRIMARY KEY,
    merchant_name VARCHAR(50) NOT NULL,
    merchant_type VARCHAR(20),
    address VARCHAR(100),
    contact_person VARCHAR(20),
    status CHAR(1) DEFAULT '1' -- 1:营业, 0:停业
);

-- 3. 一卡通表 (Cards)
CREATE TABLE cards (
    card_no CHAR(16) PRIMARY KEY,
    user_id INTEGER NOT NULL UNIQUE,
    balance DECIMAL(10,2) DEFAULT 0 CHECK(balance >= 0),
    status CHAR(1) DEFAULT '0', -- 0:正常, 1:挂失, 2:注销
    open_date TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

-- 4. 充值记录表 (Recharge_Records)
CREATE TABLE recharge_records (
    recharge_id BIGSERIAL PRIMARY KEY,
    card_no CHAR(16) NOT NULL,
    amount DECIMAL(10,2) NOT NULL CHECK(amount > 0),
    recharge_time TIMESTAMP DEFAULT NOW(),
    method VARCHAR(10),
    FOREIGN KEY (card_no) REFERENCES cards(card_no)
);

-- 5. 消费记录表 (Consumption_Records)
CREATE TABLE consumption_records (
    consumption_id BIGSERIAL PRIMARY KEY,
    card_no CHAR(16) NOT NULL,
    merchant_id INTEGER NOT NULL,
    amount DECIMAL(10,2) NOT NULL CHECK(amount > 0),
    consume_time TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (card_no) REFERENCES cards(card_no),
    FOREIGN KEY (merchant_id) REFERENCES merchants(merchant_id)
);

```

---

## 2. 阶段四：数据模拟与插入 (DML)

根据作业要求，需要模拟一定量的数据 。

**任务清单：**

* **用户表**：插入至少 20 条数据。
* **一卡通表**：插入至少 20 条数据（与用户一一对应）。
* **商户表**：插入至少 10 条数据。
* **充值记录**：插入至少 20 条数据。
* **消费记录**：插入至少 30 条数据。

**操作建议：**
您可以编写 SQL 脚本批量插入，示例如下：

```sql
-- 插入用户示例
INSERT INTO users (name, identity_no, phone, password, user_type) VALUES 
('张三', '110101200001011234', '13800138000', 'e10adc3949ba59abbe56e057f20f883e', 'Student'),
('李四', '110101200001015678', '13900139000', 'e10adc3949ba59abbe56e057f20f883e', 'Teacher');
-- ... 请继续补充至20条

-- 插入一卡通示例 (注意 user_id 要对应)
INSERT INTO cards (card_no, user_id, balance, status) VALUES 
('2023000100000001', 1, 100.00, '0'),
('2023000100000002', 2, 50.50, '0');
-- ... 请继续补充至20条

-- 插入商户示例
INSERT INTO merchants (merchant_name, merchant_type, status) VALUES 
('第一食堂', 'Canteen', '1'),
('校园超市', 'Supermarket', '1');
-- ... 请继续补充至10条

-- 插入交易记录 (注意 card_no 和 merchant_id 必须存在)
INSERT INTO recharge_records (card_no, amount, method) VALUES ('2023000100000001', 100, 'WeChat');
INSERT INTO consumption_records (card_no, merchant_id, amount) VALUES ('2023000100000001', 1, 15.00);

```

---

## 3. 阶段五：SQL 查询操作实战

根据作业文档 ，您需要编写并执行以下 SQL 语句（请截图保存执行结果）。

### 3.1 基础查询

1. **单表查询**：查询所有营业状态（status='1'）的商户信息。
2. **多表查询**：查询姓名为“张三”的用户的所有消费记录（需连接 Users, Cards, Consumption_Records）。

### 3.2 聚合查询 (至少2条)

1. 查询系统内的总用户数。
```sql
SELECT COUNT(*) FROM users;

```


2. 查询每个商户的平均单笔消费金额。
```sql
SELECT merchant_id, AVG(amount) FROM consumption_records GROUP BY merchant_id;

```



### 3.3 连接查询 (至少3条)

1. **多表连接**：查询用户姓名、卡号、消费商户名、消费金额。
2. **半连接 (EXISTS)**：查询有过消费记录的用户信息。
3. **反连接 (NOT IN / NOT EXISTS)**：查询从未充值过的用户（或卡号）。
4. **子查询**：查询单笔消费金额大于“所有记录平均消费额”的记录。

### 3.4 排序与分组

1. **ORDER BY**：查询某用户的消费记录，按时间降序排列。
2. **GROUP BY ... HAVING**：按商户分组，查询累计消费金额超过 5000 元的商户。

---

## 4. 阶段六：高级对象管理与数据维护

4.1 视图与索引 

1. **视图**：创建一个视图 `v_user_consumption`，展示用户姓名和累计消费总额。然后尝试从视图查询。
2. **索引**：在 `consumption_records` 表的 `consume_time` 字段上创建索引，以加快按时间查询的速度。

4.2 数据修改 (DML) 

1. **Update**：修改某用户的电话号码；将某商户状态改为“停业”。
2. **Delete**：删除一条错误的充值记录。

---

## 5. 阶段七：安全性与权限管理

根据文档 ：

1. 创建新用户 `card_user`，密码 `Gauss#3campus`。
2. 赋予该用户查询 `cards` 和 `consumption_records` 表的权限。
3. **验证**：使用新用户登录数据库，尝试查询表数据，并尝试修改数据（应被拒绝）。

---

## 6. 阶段八：应用开发 (Java JDBC)

最后一步是编写 Java 程序连接数据库 。

### 6.1 准备工作

* 确保 `postgresql.conf` 中 `listen_addresses = '*'`。
* 确保 `pg_hba.conf` 允许你的开发机 IP 连接。
* 下载 openGauss 的 JDBC 驱动 jar 包。

### 6.2 代码逻辑示例

编写一个 Java 类，核心代码如下：

```java
// 1. 加载驱动
Class.forName("org.opengauss.Driver");
// 2. 获取连接 (注意修改IP和端口)
Connection conn = DriverManager.getConnection(
    "jdbc:opengauss://你的ECS公网IP:26000/campus_card", 
    "card_user", 
    "Gauss#3campus"
);
// 3. 执行查询
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery("SELECT * FROM campus.merchants");
// 4. 遍历输出
while (rs.next()) {
    System.out.println(rs.getString("merchant_name"));
}

```

---

### 💡 提交建议

在执行以上每个步骤时，请务必：

1. **截图**：截取 SQL 语句输入和执行结果的屏幕。
2. **保存脚本**：将所有 SQL 语句保存在一个 `.sql` 文件中作为附件。
3. **记录问题**：如果在执行过程中报错（如权限不足、外键冲突），请记录下来并写在实验报告的“问题与解决”章节。
