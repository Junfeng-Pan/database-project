# 数据库详细设计与开发指南

## 1. 概述
本文档整合了数据库设计结构与 Java 开发所需的关键配置信息。适用于使用 Spring Boot + MyBatis-Plus 进行应用开发的场景。

## 2. 数据库连接配置

### 2.1 账号与权限说明
*   **开发账号**: `card_user`
*   **密码**: `Gauss#3campus`
*   **权限说明**: 
    *   该用户初始仅拥有部分表的查询权限。
    *   **更新状态**: 为了满足应用开发需求（增删改查），已通过脚本赋予了该用户在 `campus` 模式下所有表和序列的操作权限。
    *   *注意：如果遇到 `Permission denied` 错误，请确认是否已执行最新的授权脚本。*

### 2.2 Spring Boot 配置 (`application.properties`)
请将以下内容复制到项目的 `src/main/resources/application.properties` 文件中。

> **重要提示**: 请务必将 `<YOUR_SERVER_IP>` 替换为您云服务器的实际 **公网 IP 地址**。

```properties
# ==============================
# Web 服务器配置
# ==============================
server.port=8080

# ==============================
# openGauss 数据库连接配置
# ==============================
# 1. URL中必须指定 currentSchema=campus，否则会找不到表
spring.datasource.url=jdbc:opengauss://<YOUR_SERVER_IP>:26000/campus_card?currentSchema=campus
# 2. 使用专用的业务开发账号
spring.datasource.username=card_user
spring.datasource.password=Gauss#3campus
# 3. 指定 openGauss 驱动
spring.datasource.driver-class-name=org.opengauss.Driver

# ==============================
# 连接池配置 (HikariCP)
# ==============================
spring.datasource.type=com.zaxxer.hikari.HikariDataSource
# 最小空闲连接数
spring.datasource.hikari.minimum-idle=5
# 最大连接池大小
spring.datasource.hikari.maximum-pool-size=15
# 空闲超时时间 (毫秒)
spring.datasource.hikari.idle-timeout=30000
# 连接池名称
spring.datasource.hikari.pool-name=CampusCardHikariCP

# ==============================
# MyBatis-Plus 策略配置
# ==============================
# 实体类所在的包路径 (根据您的项目结构修改)
mybatis-plus.type-aliases-package=com.example.campus.entity
# 开启下划线转驼峰映射 (user_id -> userId)
mybatis-plus.configuration.map-underscore-to-camel-case=true
# 开启 SQL 日志打印 (便于调试)
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
# 主键生成策略: AUTO (对应数据库 SERIAL/BIGSERIAL 自增)
mybatis-plus.global-config.db-config.id-type=auto
```

## 3. 数据库对象映射参考

### 3.1 Schema 说明
所有业务表均位于 `campus` 模式下。在编写实体类时，建议显式指定 Schema。

### 3.2 核心表结构

#### 用户表 (users)
*   **Entity**: `User`
*   **TableName**: `@TableName(value = "users", schema = "campus")`
*   **关键字段**: `user_id` (主键, 自增), `name`, `identity_no`, `user_type`

#### 一卡通表 (cards)
*   **Entity**: `Card`
*   **TableName**: `@TableName(value = "cards", schema = "campus")`
*   **关键字段**: `card_no` (主键, **非自增**, 需手动输入), `user_id`, `balance`, `status`
*   **注意**: 插入数据时需注意 `card_no` 为 16 位字符。

#### 商户表 (merchants)
*   **Entity**: `Merchant`
*   **TableName**: `@TableName(value = "merchants", schema = "campus")`
*   **关键字段**: `merchant_id` (主键, 自增), `merchant_name`, `status`

#### 交易记录表 (recharge_records / consumption_records)
*   **主键策略**: 均为 `BIGSERIAL`，实体类中对应 `Long` 类型，`IdType.AUTO`。

## 4. 常见问题排查

1.  **连接超时**: 
    *   检查云服务器安全组是否放行 **26000** 端口。
    *   检查服务器防火墙状态。

2.  **找不到表 (Table not found)**:
    *   检查 URL 中是否包含 `?currentSchema=campus`。
    *   检查实体类上的 `@TableName` 注解是否包含 `schema="campus"`。

3.  **权限拒绝**:
    *   如果在插入数据时报错 `permission denied for sequence ...`，说明账号缺少序列权限。请联系管理员执行 `GRANT ALL PRIVILEGES ON ALL SEQUENCES ...`。