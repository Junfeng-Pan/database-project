# 校园一卡通消费系统详细实验操作文档 (含 Linux 执行指令)

本文档记录了在 Linux 环境下，通过 openGauss 命令行工具执行实验脚本的具体操作步骤、指令及其输出结果。

---

## 0. 准备工作

由于 openGauss 的 `omm` 用户无法直接访问 `root` 用户的家目录，执行前需将脚本拷贝至公共目录并授权：

```bash
# 1. 创建公共 SQL 目录
mkdir -p /tmp/sql

# 2. 拷贝脚本文件 (假设当前在项目根目录)
cp sql/lab_*.sql /tmp/sql/

# 3. 赋予所有用户读取权限
chmod -R 777 /tmp/sql
```

---

## 实验 1.4.5：SQL 查询操作

### 执行命令
使用 `omm` 用户身份，通过 `gsql` 指定数据库 `campus_card` 和端口 `26000` 执行脚本：
```bash
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/lab_1.4.5_queries.sql"
```

### 关键输出结果
*   **多表连接查询（张三的消费记录）**：
    ```text
     name | merchant_name | amount |        consume_time        
    ------+---------------+--------+----------------------------
     张三 | 第一食堂      |  15.00 | 2026-01-15 09:37:16.960565
     张三 | 第二食堂      |  20.00 | 2026-01-15 08:37:16.960565
     张三 | 校园超市      |   8.00 | 2026-01-14 10:37:16.960565
    ```
*   **聚合查询（总充值金额）**：
    ```text
     total_recharge_amount 
    -----------------------
                   1820.00
    ```

---

## 实验 1.4.6：视图与索引

### 执行命令
```bash
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/lab_1.4.6_objects.sql"
```

### 关键输出结果
*   **视图创建与查询**：
    ```text
    CREATE VIEW
     user_id |   name   | balance 
    ---------+----------+---------
           3 | 王五     |  200.00
           6 | 周八     |  150.00
           ...
    ```
*   **索引维护**：
    ```text
    CREATE INDEX
    REINDEX INDEX
    ALTER INDEX
    DROP INDEX
    ```

---

## 实验 1.4.7：数据修改与删除

### 执行命令
```bash
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/lab_1.4.7_data_mod.sql"
```

### 关键输出结果
脚本通过 `UPDATE` 和 `DELETE` 语句直接作用于数据库：
```text
SET
UPDATE 1  -- 成功更新张三的电话
UPDATE 1  -- 成功将卡片设为挂失状态
DELETE 1  -- 成功删除冗余充值流水
DELETE 1  -- 成功删除异常消费流水
```

---

## 实验 1.4.8：安全性管理

### 1. 创建用户与授权
**执行命令**：
```bash
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/lab_1.4.8_security.sql"
```
**结果**：输出 `CREATE ROLE` 和 `GRANT` 表示授权成功。

### 2. 新用户连接验证 (重点)
验证 `card_user` 只能访问被授权的表。

**Linux 执行指令**：
```bash
# 使用 gsql 连接，-U 指定用户名，-W 触发密码输入 (或通过 PGPASSWORD 变量)
su - omm -c "PGPASSWORD='Gauss#3campus' gsql -h 127.0.0.1 -d campus_card -U card_user -p 26000 -c \"SELECT * FROM campus.cards LIMIT 1;\""
```

**输出预期**：
*   **访问授权表 (cards)**：成功返回数据。
*   **访问未授权表 (users)**：
    ```text
    ERROR:  permission denied for relation users
    ```

### 3. 删除模式 (实验结束清理)
**执行命令**：
```bash
# 注意：此操作会清空所有业务数据，通常在期末演示结束后执行
su - omm -c "gsql -d campus_card -p 26000 -c \"DROP SCHEMA campus CASCADE;\""
```

---

## 总结
通过 Linux 终端结合 `su - omm` 指令，可以安全、高效地批量执行 SQL 任务。在实际应用开发中，建议将这些指令封装为 `.sh` 运维脚本。