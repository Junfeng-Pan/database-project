# 校园一卡通系统数据库初始化操作说明书

## 1. 概述
本文档详细记录了在 openGauss 环境中初始化“校园一卡通消费系统”数据库的全过程，包括环境检查、服务启动、脚本准备、执行初始化以及数据验证。

## 2. 环境检查与服务启动

在执行 SQL 操作前，首先确保 openGauss 数据库服务处于正常运行状态。以下操作通常在 `root` 用户下执行，通过 `su - omm` 切换至数据库管理员执行特定命令。

### 2.1 检查数据库状态
使用 `gs_om` 工具检查集群状态：
```bash
su - omm -c "gs_om -t status"
```

### 2.2 启动数据库服务
如果状态显示为 `Unavailable`，执行启动命令：
```bash
su - omm -c "gs_om -t start"
```
*注：启动成功后，集群状态应变更为 `Normal`，且默认监听端口为 `26000`。*

## 3. SQL 脚本准备

为了规范化管理，我们将数据库构建过程拆分为三个 SQL 脚本（位于 `sql/` 目录下）：

1.  **01_create_database.sql**: 创建 `campus_card` 数据库及 Schema。
2.  **02_create_tables.sql**: 定义 `users`, `cards`, `merchants`, `recharge_records`, `consumption_records` 五张核心表的结构及约束。
3.  **03_insert_data.sql**: 插入符合课程设计要求的测试数据。

## 4. 初始化执行过程

由于文件权限原因（`omm` 用户通常无法直接访问 `root` 目录下的文件），我们采取了以下步骤执行初始化。

### 4.1 权限处理
将 SQL 脚本复制到公共目录 `/tmp` 并赋予读取权限，以便 `omm` 用户读取执行：
```bash
cp -r sql /tmp/
chmod -R 777 /tmp/sql
```

### 4.2 创建数据库
首先连接默认的 `postgres` 数据库来创建新的业务数据库：
```bash
su - omm -c "gsql -d postgres -p 26000 -c \"CREATE DATABASE campus_card WITH ENCODING = 'UTF8';\""
```

### 4.3 执行 SQL 脚本
依次执行三个脚本，完成 Schema 设置、建表和数据填充：

```bash
# 1. 设置 Schema 环境
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/01_create_database.sql"

# 2. 创建表结构
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/02_create_tables.sql"

# 3. 插入模拟数据
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/03_insert_data.sql"
```

## 5. 结果验证

初始化完成后，我们对各表的数据量进行了统计，以验证操作是否成功。

### 5.1 验证命令
```bash
su - omm -c "gsql -d campus_card -p 26000 -c \"SET search_path TO campus; SELECT 'users', COUNT(*) FROM users UNION ALL SELECT 'merchants', COUNT(*) FROM merchants UNION ALL SELECT 'cards', COUNT(*) FROM cards UNION ALL SELECT 'recharge_records', COUNT(*) FROM recharge_records UNION ALL SELECT 'consumption_records', COUNT(*) FROM consumption_records;\""
```

### 5.2 验证结果
| 表名 (Table) | 记录数 (Count) | 说明 |
| :--- | :--- | :--- |
| users | 20 | 满足 ≥20 条要求 |
| merchants | 10 | 满足 ≥10 条要求 |
| cards | 20 | 满足 ≥20 条要求 |
| recharge_records | 20 | 满足 ≥20 条要求 |
| consumption_records | 30 | 满足 ≥30 条要求 |

**结论**：数据库 `campus_card` 初始化成功，表结构完整且包含足量测试数据，可进入下一阶段应用开发。
