这是一份为您定制的《校园一卡通消费系统逻辑与物理设计说明书》。

文档基于之前的需求分析和 E-R 图，将概念模型转化为具体的数据库表结构（逻辑设计），并定义了字段类型、约束条件（物理设计），同时确保所有表结构满足第三范式（3NF）。

---

# 校园一卡通消费系统逻辑与物理设计说明书

## 1. 逻辑结构设计 (Logical Design)

### 1.1 关系模式转换

根据 E-R 图，将实体和联系转化为关系模式。为了满足 **第三范式 (3NF)**，我们需要确保每个表中的非主属性只依赖于主键，且不存在传递依赖。

1. **用户表 (Users)**
* **模式**：(<u>用户ID</u>, 姓名, 身份证号, 联系方式, 电子邮箱, 登录密码, 用户类型)
* **3NF分析**：主键是“用户ID”。身份证号虽然也是唯一的，但在本设计中作为普通属性（或候选键）。所有属性直接依赖于用户ID，无传递依赖。


2. **一卡通表 (Cards)**
* **模式**：(<u>卡号</u>, 用户ID, 办卡时间, 卡片状态, 余额)
* **3NF分析**：主键是“卡号”。“用户ID”作为外键关联用户表。因为一个用户只能有一张主卡（1:1），这里将用户ID放入卡片表作为外键。所有属性依赖于卡号。


3. **商户表 (Merchants)**
* **模式**：(<u>商户编号</u>, 商户名称, 商户类型, 地址, 联系人, 营业状态)
* **3NF分析**：主键是“商户编号”。所有属性直接依赖于主键。


4. **充值记录表 (Recharge_Records)**
* **模式**：(<u>充值流水号</u>, 卡号, 充值金额, 充值时间, 充值方式)
* **3NF分析**：主键是“充值流水号”。“卡号”是外键。充值信息完全依赖于流水号。


5. **消费记录表 (Consumption_Records)**
* **模式**：(<u>消费流水号</u>, 卡号, 商户编号, 消费金额, 消费时间)
* **3NF分析**：主键是“消费流水号”。这是“一卡通”与“商户”之间 M:N 关系的实体化。包含两个外键“卡号”和“商户编号”。



### 1.2 逻辑结构设计图

下图展示了各数据表及其字段，以及表之间的外键关联关系。

```svg
<svg width="800" height="450" xmlns="http://www.w3.org/2000/svg">
  <style>
    .table-header { fill: #1976d2; stroke: #000; stroke-width: 1; }
    .table-body { fill: #f5f5f5; stroke: #000; stroke-width: 1; }
    .text-title { font-family: sans-serif; font-size: 14px; font-weight: bold; fill: #fff; text-anchor: middle; }
    .text-field { font-family: monospace; font-size: 12px; fill: #000; }
    .line-fk { stroke: #555; stroke-width: 1.5; fill: none; marker-end: url(#arrow); }
  </style>
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#555" />
    </marker>
  </defs>

  <g transform="translate(50, 50)">
    <rect class="table-header" x="0" y="0" width="140" height="25"/>
    <text x="70" y="18" class="text-title">Users (用户表)</text>
    <rect class="table-body" x="0" y="25" width="140" height="110"/>
    <text x="10" y="45" class="text-field">PK user_id</text>
    <text x="10" y="60" class="text-field">   name</text>
    <text x="10" y="75" class="text-field">   identity_no</text>
    <text x="10" y="90" class="text-field">   phone</text>
    <text x="10" y="105" class="text-field">   password</text>
    <text x="10" y="120" class="text-field">   user_type</text>
  </g>

  <g transform="translate(300, 50)">
    <rect class="table-header" x="0" y="0" width="140" height="25"/>
    <text x="70" y="18" class="text-title">Cards (一卡通表)</text>
    <rect class="table-body" x="0" y="25" width="140" height="95"/>
    <text x="10" y="45" class="text-field">PK card_no</text>
    <text x="10" y="60" class="text-field">FK user_id</text>
    <text x="10" y="75" class="text-field">   balance</text>
    <text x="10" y="90" class="text-field">   status</text>
    <text x="10" y="105" class="text-field">   open_date</text>
  </g>

  <g transform="translate(550, 150)">
    <rect class="table-header" x="0" y="0" width="150" height="25"/>
    <text x="75" y="18" class="text-title">Merchants (商户表)</text>
    <rect class="table-body" x="0" y="25" width="150" height="95"/>
    <text x="10" y="45" class="text-field">PK merchant_id</text>
    <text x="10" y="60" class="text-field">   merchant_name</text>
    <text x="10" y="75" class="text-field">   merchant_type</text>
    <text x="10" y="90" class="text-field">   address</text>
    <text x="10" y="105" class="text-field">   status</text>
  </g>

  <g transform="translate(50, 250)">
    <rect class="table-header" x="0" y="0" width="160" height="25"/>
    <text x="80" y="18" class="text-title">Recharge_Records</text>
    <rect class="table-body" x="0" y="25" width="160" height="95"/>
    <text x="10" y="45" class="text-field">PK recharge_id</text>
    <text x="10" y="60" class="text-field">FK card_no</text>
    <text x="10" y="75" class="text-field">   amount</text>
    <text x="10" y="90" class="text-field">   recharge_time</text>
    <text x="10" y="105" class="text-field">   method</text>
  </g>

  <g transform="translate(300, 250)">
    <rect class="table-header" x="0" y="0" width="160" height="25"/>
    <text x="80" y="18" class="text-title">Consumption_Records</text>
    <rect class="table-body" x="0" y="25" width="160" height="95"/>
    <text x="10" y="45" class="text-field">PK consumption_id</text>
    <text x="10" y="60" class="text-field">FK card_no</text>
    <text x="10" y="75" class="text-field">FK merchant_id</text>
    <text x="10" y="90" class="text-field">   amount</text>
    <text x="10" y="105" class="text-field">   consume_time</text>
  </g>

  <path class="line-fk" d="M190 80 L300 80"/>
  
  <path class="line-fk" d="M370 120 L370 200 L130 200 L130 250"/>

  <path class="line-fk" d="M370 120 L370 250"/>

  <path class="line-fk" d="M625 245 L625 300 L460 300"/>

</svg>

```

---

## 2. 物理设计 (Physical Design)

本部分定义了 openGauss 数据库的具体表结构，包括字段名、数据类型及完整性约束。

### 2.1 用户表 (users)

* **主键**：`user_id`
* **约束**：身份证号唯一 (`UNIQUE`)，姓名不能为空。

| 字段名 | 类型 | 长度/精度 | 约束 | 说明 |
| --- | --- | --- | --- | --- |
| **user_id** | INTEGER | - | **PK**, AUTO_INCREMENT | 用户ID，自增主键 |
| name | VARCHAR | 20 | NOT NULL | 真实姓名 |
| identity_no | CHAR | 18 | **UNIQUE**, NOT NULL | 身份证号，唯一索引 |
| phone | VARCHAR | 11 | - | 联系电话 |
| email | VARCHAR | 50 | - | 电子邮箱 |
| password | VARCHAR | 32 | NOT NULL | 登录密码 (MD5存储) |
| user_type | VARCHAR | 10 | CHECK(IN 'Student', 'Teacher') | 用户类型：学生/教职工 |

### 2.2 一卡通表 (cards)

* **主键**：`card_no`
* **外键**：`user_id` 关联 `users(user_id)`
* **约束**：余额必须大于等于0 (`CHECK constraint`)，一个用户只能有一张卡 (`UNIQUE(user_id)`).

| 字段名 | 类型 | 长度/精度 | 约束 | 说明 |
| --- | --- | --- | --- | --- |
| **card_no** | CHAR | 16 | **PK** | 16位唯一卡号 |
| user_id | INTEGER | - | **FK**, UNIQUE, NOT NULL | 关联用户ID |
| balance | DECIMAL | 10,2 | DEFAULT 0, **CHECK(>=0)** | 账户余额，不能为负 |
| status | CHAR | 1 | DEFAULT '0' | 状态(0:正常, 1:挂失, 2:注销) |
| open_date | TIMESTAMP | - | DEFAULT NOW() | 开卡时间 |

### 2.3 商户表 (merchants)

* **主键**：`merchant_id`

| 字段名 | 类型 | 长度/精度 | 约束 | 说明 |
| --- | --- | --- | --- | --- |
| **merchant_id** | INTEGER | - | **PK**, AUTO_INCREMENT | 商户编号 |
| merchant_name | VARCHAR | 50 | NOT NULL | 商户名称 |
| merchant_type | VARCHAR | 20 | - | 类型(食堂/超市/校医院等) |
| address | VARCHAR | 100 | - | 地址 |
| contact_person | VARCHAR | 20 | - | 联系人 |
| status | CHAR | 1 | DEFAULT '1' | 状态(1:营业, 0:停业) |

### 2.4 充值记录表 (recharge_records)

* **主键**：`recharge_id`
* **外键**：`card_no` 关联 `cards(card_no)`
* **约束**：充值金额必须大于0。

| 字段名 | 类型 | 长度/精度 | 约束 | 说明 |
| --- | --- | --- | --- | --- |
| **recharge_id** | BIGSERIAL | - | **PK** | 充值流水号 (大整型自增) |
| card_no | CHAR | 16 | **FK**, NOT NULL | 充值卡号 |
| amount | DECIMAL | 10,2 | NOT NULL, **CHECK(>0)** | 充值金额 |
| recharge_time | TIMESTAMP | - | DEFAULT NOW() | 充值时间 |
| method | VARCHAR | 10 | - | 方式(WeChat/Alipay/Cash) |

### 2.5 消费记录表 (consumption_records)

* **主键**：`consumption_id`
* **外键**：`card_no` 关联 `cards`，`merchant_id` 关联 `merchants`
* **约束**：消费金额必须大于0。

| 字段名 | 类型 | 长度/精度 | 约束 | 说明 |
| --- | --- | --- | --- | --- |
| **consumption_id** | BIGSERIAL | - | **PK** | 消费流水号 |
| card_no | CHAR | 16 | **FK**, NOT NULL | 消费卡号 |
| merchant_id | INTEGER | - | **FK**, NOT NULL | 消费商户 |
| amount | DECIMAL | 10,2 | NOT NULL, **CHECK(>0)** | 消费金额 |
| consume_time | TIMESTAMP | - | DEFAULT NOW() | 消费时间 |
