# 数据库约束补全操作说明

本文档说明了如何使用 `ALTER TABLE` 语句为现有的数据库表补充或重建关键的完整性约束（包括 CHECK 约束和外键约束）。

## 1. 约束需求回顾

根据需求，我们需要确保以下约束存在：
1.  **金额约束**：
    *   一卡通余额 (`cards.balance`) 必须 $\ge 0$。
    *   充值金额 (`recharge_records.amount`) 必须 $> 0$。
    *   消费金额 (`consumption_records.amount`) 必须 $> 0$。
2.  **外键关联**：
    *   `cards` 关联 `users`。
    *   `recharge_records` 关联 `cards`。
    *   `consumption_records` 关联 `cards` 和 `merchants`。

## 2. 操作脚本

已编写脚本 `sql/lab_add_constraints.sql` 来执行此操作。
该脚本采用 **"先删后加"** 的策略，即先尝试删除指定名称的约束（如果存在），再重新创建。这样既可以用于全新的无约束表，也可以用于修复或验证已有表。

### 脚本逻辑摘要
```sql
-- 添加余额检查
ALTER TABLE cards ADD CONSTRAINT cards_balance_check CHECK (balance >= 0);

-- 添加外键关联
ALTER TABLE cards ADD CONSTRAINT cards_user_id_fkey 
    FOREIGN KEY (user_id) REFERENCES users(user_id);
```

## 3. 执行指令

请在 Linux 终端执行以下命令（需具备 `omm` 权限）：

```bash
# 1. 拷贝脚本到公共目录
cp sql/lab_add_constraints.sql /tmp/sql/
chmod 777 /tmp/sql/lab_add_constraints.sql

# 2. 执行脚本
su - omm -c "gsql -d campus_card -p 26000 -f /tmp/sql/lab_add_constraints.sql"
```

## 4. 验证方法

执行完毕后，可通过以下命令查看表定义，确认约束已生效：

```bash
# 查看 cards 表详情
su - omm -c "gsql -d campus_card -p 26000 -c \"\\d+ campus.cards\""
```

预期输出中应包含 `Check constraints: "cards_balance_check" ...` 和 `Foreign-key constraints: ...` 等信息。
